---
title: "Summarize twas: chr22"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  message= F, warning = F)
```

Run simulation 9 times for ukb chr 22. 

```{r plot functions}
library(mr.ash.alpha)
library(data.table)
suppressMessages({library(plotly)})
library(tidyr)
library(plyr)
library(stringr)
library(kableExtra)
source("analysis/summarize_twas_plots.R")
```
```{r output dir}
simdatadir <- "~/causalTWAS/simulations/simulation_ashtest_20200616/"
outputdir <- "~/causalTWAS/simulations/simulation_ashtest_20200616/"
susiedir <- "~/causalTWAS/simulations/simulation_susietest_20200616/"
tags <- paste0('20200616-8-', 1:9)
tagglob <- '20200616-8-*'
tagextr <- '20200616-8-\\d+'
tag2s <- c('zeroes-es', 'zerose-es', 'lassoes-es','lassoes-se')
```

# Mr.ash2 parameter estimation
Results for 9 simulations runs, using different initiate and update strategy
```{r param function}
show_param <- function(tags, tag2){
  f <- lapply(tags, get_files, tag2 = tag2)
  parf <- lapply(f, '[[', "par")
  param <- do.call(rbind, lapply(parf, function(x) t(read.table(x))[2:1,]))
  truth <- param[1:(nrow(param)/2)*2-1,]
  est <- param[1:(nrow(param)/2)*2,]
  outdt <- matrix(0, ncol = 2*ncol(param), nrow = nrow(param)/2)
  outdt[,c(1,3,5,7)] <- truth
  outdt[,c(2,4,6,8)] <- est
  outdt <-cbind(1:nrow(outdt),outdt)
  colnames(outdt) <- c("Simulation#", paste0(rep(c("Truth","Est."),4)))
  knitr::kable(outdt) %>%
  kable_styling("striped") %>%
  add_header_above(c(" " = 1, "Gene.pi1" = 2, "Gene.PVE" = 2, "SNP.pi1" = 2, "SNP.PVE" =2))
}
```

## NULL; expr-snp; expr-snp 

```{r param 1}
show_param(tags = tags, tag2 = tag2s[1])
```

## NULL; snp-expr; expr-snp

```{r param 2}
show_param(tags = tags, tag2 = tag2s[2])
```

## lasso; expr-snp; expr-snp

```{r param 3}
show_param(tags = tags, tag2 = tag2s[3])
```

## lasso; expr-snp; snp-expr

```{r param 4}
show_param(tags = tags, tag2 = tag2s[4])
```


# Regional mr.ash2s PIP overview
Take simulation 1 (NULL; expr-snp; expr-snp) as examples. We use region size *500kb* and PIP cut off at *0.5* for SUSIE.

```{r rpip 1, fig.height=4, fig.width=10}
f <- get_files(tag= tags[1], tag2 = tag2s[1])
a <- read.table(f[["rpip"]], header = T)
par(mar=c(5, 4, 4, 6) + 0.1)
with(a, plot(p0, rPIP, col ='salmon', xlab = "position", ylab= "Sum of PIP", type = 'h', lwd = 2))
par(new = T)
with(a, plot(p0, nCausal, pch =19, col = "darkgreen",axes = FALSE, bty = "n", xlab = "", ylab = ""))
axis(side = 4)
mtext(side = 4, line = 3, 'No. causal signals')
legend("topleft",
       legend=c("Mr.ASH PIP", "# Causal"),
       lty=c(1,0), pch=c(NA, 19), col=c("salmon", "darkgreen"))
grid()
```

# PIP calibration
We run 100 simulations and combine results.

## NULL; expr-snp; expr-snp 
```{r cali 1, fig.height=4, fig.width=14}
tag2 = "zeroes-es"
tags_ext <- Reduce(intersect, get_tags(tagglob, tagextr, tag2 = tag2)['gsusie'])
res <- caliPIP_plot(tags = tags_ext, tag2 = tag2)
```
```{r cali 1fdr, fig.height=4, fig.width=4}
caliFDR_plot(tags = tags_ext, tag2 = tag2)
```

## Lasso; expr-snp; expr-snp 
```{r cali 2, fig.height=4, fig.width=14}
caliPIP_plot(tags = tags_ext, tag2 = "lassoes-es")
```

```{r cali 2fdr, fig.height=4, fig.width=4}
caliFDR_plot(tags = tags_ext, tag2 = "lassoes-es")
```


# PIP scatter plot
mr.ash2s PIP vs. susie PIP.

## NULL; expr-snp; expr-snp 
```{r sca 1, fig.height=4, fig.width=10}
scatter_plot_PIP(tags = tags, tag2 = tag2s[1])
```

## NULL; snp-expr; expr-snp

```{r sca 2, fig.height=4, fig.width=10}
scatter_plot_PIP(tags = tags, tag2 = tag2s[2])
```

## lasso; expr-snp; expr-snp

```{r sca 3, fig.height=4, fig.width=10}
scatter_plot_PIP(tags = tags, tag2 = tag2s[3])
```

## lasso; expr-snp; snp-expr

```{r sca 4, fig.height=4, fig.width=10}
scatter_plot_PIP(tags = tags, tag2 = tag2s[4])
```


# ROC curve

## NULL; expr-snp; expr-snp 
```{r roc 1, fig.height=4, fig.width=4}
ROC_plot(tags = tags, tag2 = tag2s[1])
```

## NULL; snp-expr; expr-snp

```{r roc 2, fig.height=4, fig.width=4}
ROC_plot(tags = tags, tag2 = tag2s[2])
```

## lasso; expr-snp; expr-snp

```{r roc 3, fig.height=4, fig.width=4}
ROC_plot(tags = tags, tag2 = tag2s[3])
```

## lasso; expr-snp; snp-expr

```{r roc 4, fig.height=4, fig.width=4}
ROC_plot(tags = tags, tag2 = tag2s[4])
```


# PIP vs p value

## NULL; expr-snp; expr-snp 
```{r sca_p 1, fig.height=7, fig.width=7}
scatter_plot_PIP_p(tags, tag2s[1])
```

