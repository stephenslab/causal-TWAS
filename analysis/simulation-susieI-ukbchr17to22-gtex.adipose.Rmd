---
title: "Test susieI using chr17 to 22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  message= F, warning = F)
```

Test susieI for ukb chr 17 to chr 22 combined. SNPs are downsampled to 1/10, eQTLs defined by FUSION-TWAS (Adipose/GTEx) lasso effect size > 0 were kept, p= 86k, n = 20k.

susieI is an iterative version of susie, learning parameters (`prior weights`) iteratively using the top region from mr.ash for genes only.

```{r plot functions}
library(mr.ash.alpha)
library(data.table)
suppressMessages({library(plotly)})
library(tidyr)
library(plyr)
library(stringr)
library(kableExtra)
source("analysis/summarize_twas_plots.R")
```
```{r output dir}
simdatadir <- "~/causalTWAS/simulations/simulation_ashtest_20200721/"
outputdir <- "~/causalTWAS/simulations/simulation_susieI_20200813/"
susiedir <- "~/causalTWAS/simulations/simulation_susieI_20200813/"
tag <- '20200813-1-1'
Niter <- 50
```

# MR.ASH pip distribution

* Use mr.ash for gene only:

```{r rpip 1, fig.height=6, fig.width=6}
rpipf <- paste0(outputdir, tag, "-mr.ash.rPIP.txt")

a <- read.table(rpipf, header = T)
a.c <- a[a$nCausal > 0, ]
ax <- pretty(0:max(a$rPIP), n = 30)

par(mfrow=c(2,1))
h1 <- hist(a$rPIP, breaks = 100, xlab = "PIP", main = "PIP distribution-all", col = "grey"); grid()
h2 <- hist(a.c$rPIP, breaks = h1$breaks, xlab = "PIP", main = "PIP distribution-causal", col = "salmon");grid()
```

* MR.ash2s results for the same simulated data

```{r rpip 2, fig.height=6, fig.width=6}
rpipf <- "~/causalTWAS/simulations/simulation_ashtest_20200721/20200721-1-1-mr.ash2s.lassoes-es.rPIP.txt"

a <- read.table(rpipf, header = T)
a.c <- a[a$nCausal > 0 ,]
ax <- pretty(0:max(a$rPIP), n = 30) # Make a neat vector for the breakpoints

par(mfrow=c(2,1))
h1 <- hist(a$rPIP, breaks = 100, xlab = "PIP", main = "PIP distribution-all", col = "grey"); grid()
h2 <- hist(a.c$rPIP, breaks = h1$breaks, xlab = "PIP", main = "PIP distribution-causal", col = "salmon");grid()
```

# susieI genes

Regions: We use regional PIP of both SNP and gene from mr.ash2s > 0.3 , and also require at least one causal gene or SNP is present, also, at least one gene.

Prior change for each iteration:
```{r iter}
load(paste0(outputdir, tag, ".susieIres.Rd"))
df <- cbind(prior.gene_rec, prior.SNP_rec)
rownames(df) <- paste("Iteration", 1:Niter)
colnames(df) <- c("Prior.gene", "Prior.SNP")
df
```

Results for each region:
```{r regions}
regionlist <- readRDS(paste0(outputdir, tag, "_regionlist.rds"))
ng <- unlist(lapply(lapply(regionlist, '[[', "anno"), function(x) dim(x[x$type == "gene", , drop = F ])[1]))
ns <- unlist(lapply(lapply(regionlist, '[[', "anno"), function(x) dim(x[x$type == "SNP", , drop = F ])[1]))
ng.c <- unlist(lapply(lapply(regionlist, '[[', "anno"), function(x) dim(x[x$type == "gene" & x$ifcausal == 1, , drop = F])[1]))
ns.c <- unlist(lapply(lapply(regionlist, '[[', "anno"), function(x) dim(x[x$type == "SNP" & x$ifcausal == 1, , drop = F])[1]))
ngdf <- data.frame("ngene" = ng, "nsnp" = ns, "ncausalgene" = ng.c, "ncausalSNP" = ns.c)

cat("causal gene fraction:", sum(ngdf$ncausalgene)/sum(ngdf$ngene) )
cat("causal snp fraction:", sum(ngdf$ncausalSNP)/sum(ngdf$ns))

for (i in seq(1, Niter, 10)){
  resf <- paste0(outputdir, tag, ".", i, ".susieIres.Rd") 
  load(resf)
  ngdf[, paste("Prior.gene", i)] <- unlist(lapply(gene.rpiplist, "mean"))
  ngdf[, paste("Prior.SNP", i)] <- unlist(lapply(snp.rpiplist, "mean"))
}
ngdf
```

# susieI shuffle genes
Shuffle genes to different regions. 

Prior change for each iteration:
```{r iter shuffle}
tag <- '20200813-1-1-shuffleg'
load(paste0(outputdir, tag, ".susieIres.Rd"))
df <- cbind(prior.gene_rec, prior.SNP_rec)
rownames(df) <- paste("Iteration", 1:Niter)
colnames(df) <- c("Prior.gene", "Prior.SNP")
df
```

Results for each region:
```{r regions shuffle}
regionlist <- readRDS(paste0(outputdir, tag, "_regionlist.rds"))
ng <- unlist(lapply(lapply(regionlist, '[[', "anno"), function(x) dim(x[x$type == "gene", , drop = F ])[1]))
ns <- unlist(lapply(lapply(regionlist, '[[', "anno"), function(x) dim(x[x$type == "SNP", , drop = F ])[1]))
ng.c <- unlist(lapply(lapply(regionlist, '[[', "anno"), function(x) dim(x[x$type == "gene" & x$ifcausal == 1, , drop = F])[1]))
ns.c <- unlist(lapply(lapply(regionlist, '[[', "anno"), function(x) dim(x[x$type == "SNP" & x$ifcausal == 1, , drop = F])[1]))
ngdf <- data.frame("ngene" = ng, "nsnp" = ns, "ncausalgene" = ng.c, "ncausalSNP" = ns.c)

cat("causal gene fraction:", sum(ngdf$ncausalgene)/sum(ngdf$ngene) )
cat("causal snp fraction:", sum(ngdf$ncausalSNP)/sum(ngdf$ns))

for (i in seq(1, Niter, 10)){
  resf <- paste0(outputdir, tag, ".", i, ".susieIres.Rd") 
  load(resf)
  ngdf[, paste("Prior.gene", i)] <- unlist(lapply(gene.rpiplist, "mean"))
  ngdf[, paste("Prior.SNP", i)] <- unlist(lapply(snp.rpiplist, "mean"))
}
ngdf
```
