---
title: "Test susieI using chr17 to 22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  message= F, warning = F)
```

Test susieI for ukb chr 17 to chr 22 combined. SNPs are downsampled to 1/10, eQTLs defined by FUSION-TWAS (Adipose/GTEx) lasso effect size > 0 were kept, p= 86k, n = 20k.

susieI is an iterative version of susie, learning parameters (`prior weights`) iteratively using the top region from mr.ash for genes only.

```{r plot functions}
library(mr.ash.alpha)
library(data.table)
suppressMessages({library(plotly)})
library(tidyr)
library(plyr)
library(stringr)
library(kableExtra)
source("analysis/summarize_twas_plots.R")
```
```{r output dir}
simdatadir <- "~/causalTWAS/simulations/simulation_ashtest_20200721/"
outputdir <- "~/causalTWAS/simulations/simulation_susieI_20200813/"
susiedir <- "~/causalTWAS/simulations/simulation_susieI_20200813/"
mrashdir <- "~/causalTWAS/simulations/simulation_ashtest_20200721/"
tag <- '20200813-1-1'
Niter <- 30
```

# MR.ASH pip distribution

* Use mr.ash for gene only:

```{r rpip 1, fig.height=6, fig.width=6}
rpipf <- paste0(outputdir, tag, "-mr.ash.rPIP.txt")

a <- read.table(rpipf, header = T)
a.c <- a[a$nCausal > 0, ]
ax <- pretty(0:max(a$rPIP), n = 30)

par(mfrow=c(2,1))
h1 <- hist(a$rPIP, breaks = 100, xlab = "PIP", main = "PIP distribution-all", col = "grey"); grid()
h2 <- hist(a.c$rPIP, breaks = h1$breaks, xlab = "PIP", main = "PIP distribution-causal", col = "salmon");grid()
```

* MR.ash2s results for the same simulated data

```{r rpip 2, fig.height=6, fig.width=6}
rpipf <- "~/causalTWAS/simulations/simulation_ashtest_20200721/20200721-1-1-mr.ash2s.lassoes-es.rPIP.txt"

a <- read.table(rpipf, header = T)
a.c <- a[a$nCausal > 0 ,]
ax <- pretty(0:max(a$rPIP), n = 30) # Make a neat vector for the breakpoints

par(mfrow=c(2,1))
h1 <- hist(a$rPIP, breaks = 100, xlab = "PIP", main = "PIP distribution-all", col = "grey"); grid()
h2 <- hist(a.c$rPIP, breaks = h1$breaks, xlab = "PIP", main = "PIP distribution-causal", col = "salmon");grid()
```

# susieI genes - setting 1

* Regions: We use regional PIP of both SNP and gene from mr.ash2s > 0.3, and also require at least one causal gene or SNP is present, also, at least one gene.

* Susie run parameters: `L=1`, `null_weight = 0`, didn't update `null_weight` in iterations. We initialize with prior for genes and SNPs as uniform.

## One example

Prior change for each iteration:
```{r iter}
load(paste0(outputdir, tag, ".susieIres.Rd"))
df <- cbind(prior.gene_rec, prior.SNP_rec)
rownames(df) <- paste("Iteration", 1:Niter)
colnames(df) <- c("Prior.gene", "Prior.SNP")
df
```

## more examples

Each row represents one simulation run. Runs labeled `1-x` have the same simulation parameters, as you can tell from the true parameters. (and so are runs labled `2-x` and `3-x`)

```{r param}
show_param <- function(mrashfs, susieIfs, susieIfs2){
  param <- do.call(rbind, lapply(mr.ashfs, function(x) t(read.table(x))[2:1,]))
 
  pars <- cbind(param[seq(1,nrow(param), 2), 2], param[seq(1,nrow(param), 2), 4], param[seq(1,nrow(param), 2), 1], param[seq(2,nrow(param), 2), 1], param[seq(1,nrow(param), 2), 3], param[seq(2,nrow(param), 2), 3])
  colnames(pars) <- c("PVE.gene_truth", "PVE.SNP_truth", paste(rep(c("pi1.gene_", "pi1.SNP_"), each = 2), c("truth", "mr.ash2"), sep = ""))
    
  param.s <- do.call(rbind, lapply(susieIfs, function(x) {load(x); c(tail(prior.gene_rec, 1), tail(prior.SNP_rec,1))}))
  
  param.s.truth <- do.call(rbind, lapply(susieIfs2, function(x) {
    a <- read.table(x, header = T);
    c(nrow(a[a$ifcausal == 1 & a$type == "gene", , drop = F])/ nrow(a[a$type == "gene", , drop = F]),
      nrow(a[a$ifcausal == 1 & a$type == "SNP", , drop = F])/ nrow(a[a$type == "SNP", , drop = F]))
    }))
  
  pars.s <- cbind(param.s.truth, param.s)[, c(1,3,2,4)]
  colnames(pars.s) <-  paste(rep(c("pi1.gene_", "pi1.SNP_"), each = 2), c("susietruth", "susieI"), sep = "")
  
  df <- cbind(tags, format(pars, digits = 4), format(pars.s, digits =4))
  rownames(df) <- NULL
  
  df %>% 
  kable("html", escape = F) %>%
  kable_styling("striped", full_width = F) %>%
   row_spec(c(1:5, 11:15), background = "#FEF3B9") %>%
  scroll_box(width = "100%", height = "600px", fixed_thead = T)
}

tags <- paste(rep(1:3, each = 5), 1:5, sep = "-")
mr.ashfs <- paste0(mrashdir, "20200721-", tags, "-mr.ash2s.lassoes-es.param.txt")
susieIfs <- paste0(outputdir, "20200813-", tags, ".susieIres.Rd")
susieIfs2 <- paste0(outputdir, "20200813-", tags, ".1.txt")

show_param(mrashfs, susieIfs, susieIfs2)
```


# susieI genes - setting 2

* Regions: All regions. 

* Susie run parameters: `L=1`. initialize with `null_weight = 0` and update `null_weight` based on last iteration results. We initialize with prior for genes and SNPs as uniform.

## One example

Prior change for each iteration:
```{r iter2}
load(paste0(outputdir, tag, ".config1.susieIres.Rd"))
df <- cbind(prior.gene_rec, prior.SNP_rec)
rownames(df) <- paste("Iteration", 1:Niter)
colnames(df) <- c("Prior.gene", "Prior.SNP")
df
```

## More examples

```{r param2}
tags <- paste(rep(1:4, each = 5), 1:5, sep = "-")
mr.ashfs <- paste0(mrashdir, "20200721-", tags, "-mr.ash2s.lassoes-es.param.txt")
susieIfs <- paste0(outputdir, "20200813-", tags, ".config1.susieIres.Rd")
susieIfs2 <- paste0(outputdir, "20200813-", tags, ".config1.susieI.txt")

show_param(mrashfs, susieIfs, susieIfs2)
```

# susieI genes - setting 3

* Regions: All regions. 

* Susie run parameters: `L=2`. initialize with `null_weight = 0` and update `null_weight` based on last iteration results. We initialize with prior for genes and SNPs as uniform.

## One example

Prior change for each iteration:
```{r iter3}
load(paste0(outputdir, tag, ".config2.susieIres.Rd"))
df <- cbind(prior.gene_rec, prior.SNP_rec)
rownames(df) <- paste("Iteration", 1:Niter)
colnames(df) <- c("Prior.gene", "Prior.SNP")
df
```

## More examples

```{r param3}
mr.ashfs <- paste0(mrashdir, "20200721-", tags, "-mr.ash2s.lassoes-es.param.txt")
susieIfs <- paste0(outputdir, "20200813-", tags, ".config2.susieIres.Rd")
susieIfs2 <- paste0(outputdir, "20200813-", tags, ".config2.susieI.txt")

show_param(mrashfs, susieIfs, susieIfs2)
```


# susieI genes - setting 4

* Regions: All regions. 

* Susie run parameters: `L=1`. Did not update `null_weight` in each iteration. We initialize with prior for genes and SNPs as uniform.

## One example

Prior change for each iteration:
```{r iter4}
load(paste0(outputdir, tag, ".config3.susieIres.Rd"))
df <- cbind(prior.gene_rec, prior.SNP_rec)
rownames(df) <- paste("Iteration", 1:Niter)
colnames(df) <- c("Prior.gene", "Prior.SNP")
df
```

## More examples

```{r param4}
mr.ashfs <- paste0(mrashdir, "20200721-", tags, "-mr.ash2s.lassoes-es.param.txt")
susieIfs <- paste0(outputdir, "20200813-", tags, ".config3.susieIres.Rd")
susieIfs2 <- paste0(outputdir, "20200813-", tags, ".config3.susieI.txt")

show_param(mrashfs, susieIfs, susieIfs2)
```

# susieI genes - setting 5

* Regions: All regions. 

* Susie run parameters: `L=5`. Update `null_weight` in each iteration. We initialize prior for gene as `0.05` and prior for SNPs as `2.5E-3`, we initialize `null_weight` as 0.

## One example

Prior change for each iteration:
```{r iter5}
load(paste0(outputdir, tag, ".config4.susieIres.Rd"))
df <- cbind(prior.gene_rec, prior.SNP_rec)
rownames(df) <- paste("Iteration", 1:Niter)
colnames(df) <- c("Prior.gene", "Prior.SNP")
df
```

## More examples

```{r param5}
mr.ashfs <- paste0(mrashdir, "20200721-", tags, "-mr.ash2s.lassoes-es.param.txt")
susieIfs <- paste0(outputdir, "20200813-", tags, ".config4.susieIres.Rd")
susieIfs2 <- paste0(outputdir, "20200813-", tags, ".config4.susieI.txt")

show_param(mrashfs, susieIfs, susieIfs2)
```

# susieI genes - setting 6

* Regions: All regions. 

* Susie run parameters: `L=2`. Update `null_weight` in each iteration. We initialize prior for gene as `0.05` and prior for SNPs as `2.5E-3`, we initialize `null_weight` as 0.

## One example

Prior change for each iteration:
```{r iter6}
load(paste0(outputdir, tag, ".config5.susieIres.Rd"))
df <- cbind(prior.gene_rec, prior.SNP_rec)
rownames(df) <- paste("Iteration", 1:Niter)
colnames(df) <- c("Prior.gene", "Prior.SNP")
df
```

## More examples

```{r param6}
mr.ashfs <- paste0(mrashdir, "20200721-", tags, "-mr.ash2s.lassoes-es.param.txt")
susieIfs <- paste0(outputdir, "20200813-", tags, ".config5.susieIres.Rd")
susieIfs2 <- paste0(outputdir, "20200813-", tags, ".config5.susieI.txt")

show_param(mrashfs, susieIfs, susieIfs2)
```

# susieI shuffle genes
## one example
* Shuffle genes to different regions. Regions: We use regional PIP of both SNP and gene from mr.ash2s > 0.3 , and also require at least one causal gene or SNP is present, also, at least one gene.

* Susie run parameters: `L=1`, `null_weight = 0`.

Prior change for each iteration:
```{r iter shuffle}
tag <- '20200813-1-1-shuffleg'
load(paste0(outputdir, tag, ".susieIres.Rd"))
df <- cbind(prior.gene_rec, prior.SNP_rec)
rownames(df) <- paste("Iteration", 1:nrow(df))
colnames(df) <- c("Prior.gene", "Prior.SNP")
df
```

