---
title: "Summarize twas: chr17 to 22"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  message= F, warning = F)
```

* Run susie with different priors and see how much prior affects results. 

* Data: ukb chr 17 to chr 22 combined. SNPs are downsampled to 1/10, eQTLs defined by FUSION-TWAS (Adipose/GTEx) lasso effect size > 0 were kept, p= 86k, n = 20k.

* For each simulation scenarios(1-x, 3-x), we picked two few parameter sets (priors for gene and snps) estimated by susieI and check if PIPs for genes are calibrated.

```{r plot functions}
library(mr.ash.alpha)
library(data.table)
suppressMessages({library(plotly)})
library(tidyr)
library(plyr)
library(stringr)
library(kableExtra)
source("analysis/summarize_twas_plots.R")
```

# Test true prior

## Regions rPIP > 0.5, simulation 1-x
```{r output-t dir}
simdatadir <- "~/causalTWAS/simulations/simulation_ashtest_20200721/"
outputdir <- "~/causalTWAS/simulations/simulation_ashtest_20200721/"
susiedir <- "/home/simingz/causalTWAS/simulations/simulation_susietest_20200721/20200721-1-fixprior_rpip0.5/"
```

We run 50 simulations and run susie using the true parameter (gene and snp pi1) as prior. We run susie for regions with regional sum of pip from mr.ash2s for both genes and snps > 0.5. run susie with L=1. 

### Truth

* The true parameters we used to simulate data: 
```{r  true par-t}
par <- read.table(paste0(susiedir, "20200721-1-fixedprior_2.txt"), header = T)
t(par[,2, drop = F])
```

### Use truth as prior

* The prior used is: 
```{r  par1-t}
par <- read.table(paste0(susiedir, "20200721-1-fixedprior_2.txt"), header = T)
t(par[c(1,3),1, drop = F])
susiedir <- "/home/simingz/causalTWAS/simulations/simulation_susietest_20200721/20200721-1-fixprior_rpip0.5/"
```
* susie results: 
```{r cali 1-t, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-1-*.fixedprior2.L1.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3))
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```

## Regions rPIP > 0.9, simulation 3-x
We run 50 simulations and run susie using the true parameter (gene and snp pi1) as prior. We run susie for regions with regional sum of pip from mr.ash2s for both genes and snps > 0.9. run susie with L= 2. 

### Truth

* The true parameters we used to simulate data: 
```{r  true par-t0.9}
susiedir <- "/home/simingz/causalTWAS/simulations/simulation_susietest_20200721/20200721-3-fixprior_rpip0.9/"
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_2.txt"), header = T)
t(par[,2, drop = F])
```

### Use truth as prior

* The prior used is: 
```{r  par1-t0.9}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_2.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 1-t0.9, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-3-*.fixedprior2.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3))
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```


## Causal regions, simulation 3-x
We run susie for regions with causal signals. run susie with L=1. 

### Truth

* The true parameters we used to simulate data: 
```{r  true par-t3}
susiedir <- "/home/simingz/causalTWAS/simulations/simulation_susietest_20200721/20200721-3-fixprior_causal/"
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_2.txt"), header = T)
t(par[,2, drop = F])
```

### Use truth as prior

* The prior used is: 
```{r  par1-t3}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_2.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 1-t3, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-3-*.fixedprior2.L1.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3)); 
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```

## All regions, simulation 3-x
We run susie for all regions. Run susie with L=1. 

### Truth

* The true parameters we used to simulate data: 
```{r  true par-a3}
susiedir <- "/project2/mstephens/causalTWAS/simulations/simulation_susietest_20200721/20200721-3-fixprior_allregions/"
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_2.txt"), header = T)
t(par[,2, drop = F])
```

### Use truth as prior

* The prior used is: 
```{r  par1-a3}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_2.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 1-a3, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-3-*.fixedprior2.L1.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3)); 
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```


# Test over and underestimated gene pi1
We intentionally use over or underestimated gene pi1 and use the same snp pi1 (close to truth) when running SUSIE. Run susie `L=1`.

## Causal regions, simulation 3-x

* The true parameters we used to simulate data: 
```{r  par-over-t}
susiedir <- "/home/simingz/causalTWAS/simulations/simulation_susietest_20200721/20200721-3-fixprior_causal/"
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_2.txt"), header = T)
t(par[,2, drop = F])
```

### Use overestimated gene pi1

* The prior used is: 
```{r  par1-t3-over}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_1.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 1-t3-over, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-3-*.fixedprior1.L1.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3))
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```

### Use underrestimated gene pi1

* The prior used is: 
```{r  par1-t3-under}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_3.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 1-t3-under, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-3-*.fixedprior3.L1.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3))
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```

## Test susieI results
# Simulation 1-x, setting 1

```{r output dir}
simdatadir <- "~/causalTWAS/simulations/simulation_ashtest_20200721/"
outputdir <- "~/causalTWAS/simulations/simulation_ashtest_20200721/"
susiedir <- "~/causalTWAS/simulations/simulation_susietest_20200721/20200721-1-fixprior_rpip0.3_causal/"
```

We run 100 simulations and run susie using priors obtained from susieI. Two examples are shown. The setting is the same as in [here](https://stephenslab.github.io/causal-TWAS/simulation-susieI-ukbchr17to22-gtex.adipose.html#regions:_causal). Regions are rpip from mr.ash2 > 0.3 and causal. We take simulation setting 1-x.

## Truth

* The true parameters we used to simulate data: 
```{r  true par}
par <- read.table(paste0(susiedir, "20200721-1-fixedprior_1.txt"), header = T)
t(par[,2, drop = F])
```

## Use prior from susie estimates 1.

* The prior used is: 
```{r  par1}
par <- read.table(paste0(susiedir, "20200721-1-fixedprior_1.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 1, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-1-*.fixedprior1.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3))
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```

## Use prior from susie estimates 2.

* The prior used is: 
```{r  par2}
par <- read.table(paste0(susiedir, "20200721-1-fixedprior_2.txt"), header = T)
t(par[c(1,3),1, drop = F])
```

```{r cali 2, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-1-*.fixedprior2.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3))
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```


# simulation 1-x, setting 2

```{r output a dir}
susiedir <- "~/causalTWAS/simulations/simulation_susietest_20200721/20200721-1-fixprior_rpip0.3/"
```

We run 100 simulations and run susie using priors obtained from susieI. Two examples are shown. The setting is the same as in [here](https://stephenslab.github.io/causal-TWAS/simulation-susieI-ukbchr17to22-gtex.adipose.html#regions:_mrash_gene+snp_(1)). Regions are rpip from mr.ash2 > 0.3. We take simulation setting 1-x.

## Truth

* The true parameters we used to simulate data: 
```{r  true a par}
par <- read.table(paste0(susiedir, "20200721-1-fixedprior_1.txt"), header = T)
t(par[,2, drop = F])
```

## Use prior from susie estimates 1.

* The prior used is: 
```{r  par1 a}
par <- read.table(paste0(susiedir, "20200721-1-fixedprior_1.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 1 a, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-1-*.fixedprior1.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3))
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```

## Use prior from susie estimates 2.

* The prior used is: 
```{r  par2 a}
par <- read.table(paste0(susiedir, "20200721-1-fixedprior_2.txt"), header = T)
t(par[c(1,3),1, drop = F])
```

```{r cali 2 a, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-1-*.fixedprior2.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3)) 
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```

# Simulation 3-x, setting 1

```{r output 3.1 dir}
susiedir <- "~/causalTWAS/simulations/simulation_susietest_20200721/20200721-3-fixprior_rpip0.3_causal/"
```

We run 100 simulations and run susie using priors obtained from susieI. Two examples are shown. The setting is the same as in [here](https://stephenslab.github.io/causal-TWAS/simulation-susieI-ukbchr17to22-gtex.adipose.html#regions:_causal). Regions are rpip from mr.ash2 > 0.3 and causal. We take simulation setting 3-x.

## Truth

* The true parameters we used to simulate data: 
```{r  true par 3.1}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_1.txt"), header = T)
t(par[,2, drop = F])
```

## Use prior from susie estimates 1.

* The prior used is: 
```{r  par1-2}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_1.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 1-2, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-3-*.fixedprior1.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3))
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```

## Use prior from susie estimates 2.

* The prior used is: 
```{r  par2-2}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_2.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 2-2, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-3-*.fixedprior2.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3))
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```

# Simulation 3-x, setting 2

```{r output dir 3.2}
susiedir <- "~/causalTWAS/simulations/simulation_susietest_20200721/20200721-3-fixprior_rpip0.3/"
```

We run 100 simulations and run susie using priors obtained from susieI. Two examples are shown. The setting is the same as in [here](https://stephenslab.github.io/causal-TWAS/simulation-susieI-ukbchr17to22-gtex.adipose.html#regions:_mrash_gene+snp_(1)). Regions are rpip from mr.ash2 > 0.3. We take simulation setting 1-x.

## Truth

* The true parameters we used to simulate data: 
```{r  true par3.2}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_1.txt"), header = T)
t(par[,2, drop = F])
```

## Use prior from susie estimates 1.

* The prior used is: 
```{r  par3.2.1}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_1.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 3.2.1, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-3-*.fixedprior2.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3))
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```

## Use prior from susie estimates 2.

* The prior used is: 
```{r  par 3.2.2}
par <- read.table(paste0(susiedir, "20200721-3-fixedprior_2.txt"), header = T)
t(par[c(1,3),1, drop = F])
```
* susie results: 
```{r cali 3.2.2, fig.height=4, fig.width=12}
pipfs <- Sys.glob(paste0(susiedir,"20200721-3-*.fixedprior2.susieres.expr.txt"))
res <- do.call(rbind, lapply(pipfs, read.table, header = T))
par(mfrow=c(1,3)) 
cp_plot(res$pip.null, res$ifcausal, main = "SUSIE.uniform PIP")
cp_plot(res$pip, res$ifcausal, main = "SUSIE.weighted PIP")
cp_plot(res$pip.w0, res$ifcausal, main = "SUSIE.weighted-w-null PIP")
```



